<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formalizar Cota√ß√£o</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f9fafb;
      color: #222;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      height: 100vh;
      background-color: #1e3a8a;
      color: white;
      padding: 30px 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      font-weight: 600;
    }
    #sidebar a {
      color: white;
      text-decoration: none;
      padding: 12px 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: block;
      transition: background-color 0.3s ease;
    }
    #sidebar a:hover,
    #sidebar a.active {
      background-color: #2563eb;
    }
    #main-content {
      margin-left: 250px;
      padding: 40px 50px;
      background: white;
      overflow-y: auto;
      box-sizing: border-box;
      flex-grow: 1;
    }
    h1 {
      color: #1e3a8a;
      font-weight: 700;
      margin-bottom: 30px;
      font-size: 2.5rem;
    }
    form {
      background: #f3f4f6;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 40px;
      max-width: 800px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      margin-top: 20px;
      color: #374151;
    }
    input[type="text"], input[type="date"], select, textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1.8px solid #d1d5db;
      font-size: 1rem;
      font-family: inherit;
      color: #334155;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 6px #2563ebaa;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    select[multiple] {
      height: 100px;
      cursor: pointer;
    }
    button {
      margin-top: 30px;
      background-color: #2563eb;
      border: none;
      color: white;
      font-weight: 700;
      padding: 15px 32px;
      font-size: 1.15rem;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.5);
    }
    button:hover {
      background-color: #1e40af;
    }
    ul {
      padding-left: 20px;
      color: #374151;
    }
    .flash-message {
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 32px;
      border-radius: 20px;
      font-weight: 700;
      box-shadow: 0 6px 22px rgba(74, 222, 128, 0.9);
      z-index: 11000;
      user-select: none;
      transition: opacity 0.5s ease-in-out;
    }
    .flash-success {
      background-color: #4ade80;
      color: #065f46;
    }
    .flash-error {
      background-color: #f87171;
      color: #7f1d1d;
      box-shadow: 0 6px 22px rgba(248, 113, 113, 0.8);
    }
    @media (max-width: 900px) {
      #main-content {
        margin-left: 0;
        width: 100%;
        padding: 20px;
      }
      #sidebar {
        position: relative;
        width: 100%;
        height: auto;
        box-shadow: none;
        padding: 16px 12px;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        gap: 14px;
      }
      #sidebar a {
        font-size: 0.9rem;
        padding: 8px 12px;
        border-radius: 10px;
      }
    }
  </style>
</head>
<body>
  
<div id="sidebar" role="navigation" aria-label="Menu principal">
  <nav>
    <div class="menu-section">
      <h3>Setor de Compras</h3>
      <a href="{{ url_for('controle') }}" class="{% if pagina_ativa == 'controle' %}active{% endif %}">
        <span class="icon" aria-hidden="true">üìÖ</span><span>Controle RM</span>
      </a>
      <a href="{{ url_for('pedidos_compras') }}" class="{% if pagina_ativa == 'pedidos_compras' %}active{% endif %}">
        <span class="icon" aria-hidden="true">üìã</span><span>Pedidos de Compras</span>
      </a>
      <a href="{{ url_for('oc') }}" class="{% if pagina_ativa == 'oc' %}active{% endif %}">
        <span class="icon" aria-hidden="true">üõí</span><span>OC</span>
      </a>
      <a href="{{ url_for('busca_arquivos') }}" class="{% if pagina_ativa == 'busca_arquivos' %}active{% endif %}">
        <span class="icon" aria-hidden="true">üìÇ</span><span>Buscar Arquivos</span>
      </a>
    </div>
    <div class="menu-section">
      <h3>Almoxarifado</h3>
      <a href="{{ url_for('acompanhamento_entregas') }}"><span class="icon" aria-hidden="true">üì¶</span><span>Entregas</span></a>
    </div>
    <div class="menu-section">
      <h3>Frota</h3>
      <a href="{{ url_for('frota_expedicao') }}"><span class="icon" aria-hidden="true">üöö</span><span>Expedi√ß√£o</span></a>
    </div>
  </nav>
</div>
<main id="main-content">
  <div style="display:flex; justify-content:flex-start; margin-bottom:10px;">
    <button onclick="window.location.href='{{ url_for('controle') }}'" 
            style="padding:6px 12px; font-size:0.95rem; background-color:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer;">
        ‚Üê Voltar
    </button>
  </div>
  
  <h1>Formalizar Cota√ß√£o</h1>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash-message {% if category == 'error' %}flash-error{% else %}flash-success{% endif %}" role="alert" id="flash-message">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

<!-- Bot√£o para abrir/fechar lista de fornecedores -->
<button type="button" class="btn btn-secondary mb-3" onclick="toggleFornecedores()">
    Gerenciar Fornecedores
</button>

<!-- Lista de fornecedores (inicialmente escondida) -->
<div id="fornecedores-panel" style="display:none; border:1px solid #ccc; padding:15px; border-radius:8px; margin-bottom:20px;">
    <h4>Fornecedores Cadastrados</h4>

    <!-- Formul√°rio para adicionar novo fornecedor -->
    <form method="POST" action="{{ url_for('adicionar_fornecedor') }}" class="mb-3">
        <input type="text" name="nome" placeholder="Nome do fornecedor" required>
        <input type="email" name="email" placeholder="Email" required>
        <button type="submit" class="btn btn-success btn-sm">Adicionar</button>
    </form>

    <!-- Tabela de fornecedores -->
    <table class="table table-sm">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for f in fornecedores %}
            <tr>
                <td>{{ f.nome }}</td>
                <td>{{ f.email }}</td>
                <td>
                    <form method="POST" action="{{ url_for('excluir_fornecedor', email=f.email) }}" style="display:inline;">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Deseja realmente excluir este fornecedor?');">
                            Excluir
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function toggleFornecedores() {
    const panel = document.getElementById("fornecedores-panel");
    panel.style.display = panel.style.display === "none" ? "block" : "none";
}
</script>
  
  {% if rm_aprovadas %}
    {% for r in rm_aprovadas %}
      <form method="POST" aria-label="Formul√°rio pedido de cota√ß√£o RM {{ r.id_req }}">
        <input type="hidden" name="rm_number" value="{{ r.id_req }}" />

        <!-- Cabe√ßalho Executivo -->
        <div style="border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 20px;">
          <h2 style="color:#1e3a8a;">Pedido de Cota√ß√£o - RM {{ r.id_req }}</h2>
          <p style="font-weight:600;">Solicitante: {{ r.requisitante }}</p>
          <p>Data de Emiss√£o: {{ data_emissao.strftime('%d/%m/%Y') }}</p>
          <p>Refer√™ncia: Requisi√ß√£o Interna de Materiais - RM {{ r.id_req }}</p>
        </div>

        <!-- Objetivo do Pedido -->
        <label style="font-weight:700;">Objetivo:</label>
        <p>Este pedido de cota√ß√£o tem como objetivo obter propostas comerciais para aquisi√ß√£o dos itens listados abaixo, garantindo o melhor custo, prazo e condi√ß√µes comerciais para nossa empresa.</p>

        <!-- Itens para Cota√ß√£o -->
        <label style="font-weight:700;">Itens Requeridos:</label>
        <ul>
          {% for item in r.itens %}
            <li>
              <strong>{{ item.quantidade }} x {{ item.descricao }}</strong>
              {% if item.observacoes %}<br><em>Observa√ß√£o:</em> {{ item.observacoes }}{% endif %}
            </li>
          {% endfor %}
        </ul>

        <!-- Sele√ß√£o de Fornecedores -->
        <label for="fornecedores_{{ r.id_req }}" style="font-weight:700;">
          Fornecedores Contatados <span aria-hidden="true" style="color:#dc2626;">*</span>
        </label>
        <select name="fornecedores[]" multiple class="form-select" required>
          {% for fornecedor in fornecedores %}
            <option value="{{ fornecedor.email }}">{{ fornecedor.nome }} ({{ fornecedor.email }})</option>
          {% endfor %}
        </select>
        <div id="desc_fornecedores_{{ r.id_req }}" style="font-size: 0.85rem; color: #6b7280; margin-top: 4px;">
          Segure Ctrl (Windows) ou Cmd (Mac) para selecionar m√∫ltiplos fornecedores
        </div>

        <!-- Condi√ß√µes Requeridas -->
        <label for="prazo_entrega_{{ r.id_req }}" style="font-weight:700;">Prazo de Entrega Desejado <span aria-hidden="true" style="color:#dc2626;">*</span></label>
        <input type="date" id="prazo_entrega_{{ r.id_req }}" name="prazo_entrega" required />

        <label for="condicoes_{{ r.id_req }}" style="font-weight:700;">Condi√ß√µes Comerciais Esperadas:</label>
        <textarea id="condicoes_{{ r.id_req }}" name="condicoes" placeholder="Ex.: Condi√ß√µes de pagamento, descontos aplic√°veis, validade da proposta, garantias e log√≠stica."></textarea>

        <label for="observacoes_{{ r.id_req }}" style="font-weight:700;">Observa√ß√µes Complementares (opcional)</label>
        <textarea id="observacoes_{{ r.id_req }}" name="observacoes" placeholder="Ex.: Requisitos de embalagem, transporte, padr√µes de qualidade ou certifica√ß√µes necess√°rias."></textarea>

        <!-- Instru√ß√µes de Resposta -->
        <div style="background:#f3f4f6; padding:15px; border-radius:8px; margin-top:20px; border-left: 4px solid #2563eb;">
          <p style="font-weight:600;">Instru√ß√µes ao Fornecedor:</p>
          <ul style="margin-left:20px;">
            <li>Enviar proposta detalhada, mencionando pre√ßos unit√°rios e totais.</li>
            <li>Informar condi√ß√µes de pagamento, prazo de entrega e validade da cota√ß√£o.</li>
            <li>Especificar garantias, frete e log√≠stica de entrega.</li>
            <li>Enviar a resposta at√© a data limite especificada no campo <strong>Prazo de Entrega Desejado</strong>.</li>
          </ul>
        </div>

        <!-- Bot√£o -->
        <button type="submit" aria-label="Enviar pedido de cota√ß√£o para RM {{ r.id_req }}">
          Enviar Pedido de Cota√ß√£o
        </button>
      </form>
    {% endfor %}
  {% else %}
    <p style="color:#6b7280; font-size:1.1rem; margin-top:40px;">
      Nenhuma Requisi√ß√£o com status <strong>"Solicita√ß√£o Aprovada"</strong> dispon√≠vel para cota√ß√£o no momento.
    </p>
  {% endif %}



  <section style="margin-top: 60px; max-width: 800px;">
    <h2>Pedidos de Cota√ß√£o Enviados</h2>
    {% if pedidos_cotacao %}
      <ul style="color:#374151; font-size: 1rem; line-height: 1.5rem;">
        {% for p in pedidos_cotacao %}
          <li>RM {{ p.rm_number }} enviada em {{ p.data_envio }} para {{ p.fornecedores | join(", ") }} - Prazo: {{ p.prazo_entrega }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p style="color:#6b7280;">Nenhum pedido de cota√ß√£o enviado at√© o momento.</p>
    {% endif %}
  </section>
</main>

<script>
  // Esconde a mensagem flash automaticamente ap√≥s 4 segundos
  window.onload = function() {
    const flash = document.getElementById("flash-message");
    if (flash) {
      setTimeout(() => {
        flash.style.opacity = '0';
        setTimeout(() => flash.remove(), 600);
      }, 4000);
    }
  };
</script>
</body>
</html>
